name: TeamFees Real Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
  push:
    branches: [ main ]
    paths:
    - 'src/**'
    - 'TeamFees.dpr'
    - 'TeamFees.dproj'

jobs:
  # Job 1: Verificar se bin√°rio existe (compilado localmente)
  check-binary:
    name: Check Binary
    runs-on: ubuntu-latest
    outputs:
      binary-exists: ${{ steps.check.outputs.exists }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check if Linux binary exists
      id: check
      run: |
        if [ -f "Linux64/Release/TeamFees" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Linux binary found"
          ls -la Linux64/Release/TeamFees
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ùå Linux binary not found"
          echo "üí° Compile locally first: Open Delphi ‚Üí Build ‚Üí Linux64 Release"
        fi

  # Job 2: Deploy Real (apenas se bin√°rio existir)
  deploy-real:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: check-binary
    if: needs.check-binary.outputs.binary-exists == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Create backup on server
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üîÑ Creating backup on server..."
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          if [ -f /home/administrator/TeamFees ]; then
            sudo cp /home/administrator/TeamFees /home/administrator/TeamFees.backup.$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backup created"
          else
            echo "‚ÑπÔ∏è No existing binary to backup"
          fi
        EOF
        
    - name: Prepare server directory
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üîß Preparing server directory..."
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          # Ensure home directory is writable
          chmod 755 /home/administrator
          
          # Create temp directory for upload
          mkdir -p /tmp/teamfees-deploy
          chmod 777 /tmp/teamfees-deploy
          
          echo "‚úÖ Directory prepared"
        EOF
        
    - name: Upload binary to server
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üì§ Uploading binary to server..."
        
        # Upload to temp directory first
        scp -o StrictHostKeyChecking=no Linux64/Release/TeamFees $SERVER_USER@$SERVER_HOST:/tmp/teamfees-deploy/
        
        # Upload .so files if they exist
        if ls Linux64/Release/*.so 1> /dev/null 2>&1; then
          scp -o StrictHostKeyChecking=no Linux64/Release/*.so $SERVER_USER@$SERVER_HOST:/tmp/teamfees-deploy/
          echo "‚úÖ Shared libraries uploaded"
        fi
        
        # Move files to final location
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          # Move binary to home directory
          mv /tmp/teamfees-deploy/TeamFees /home/administrator/
          
          # Move .so files if they exist
          if ls /tmp/teamfees-deploy/*.so 1> /dev/null 2>&1; then
            mv /tmp/teamfees-deploy/*.so /home/administrator/
          fi
          
          # Clean up temp directory
          rm -rf /tmp/teamfees-deploy
          
          echo "‚úÖ Files moved to final location"
        EOF
        
        echo "‚úÖ Binary uploaded successfully"
        
    - name: Set permissions and restart service
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üîß Setting permissions and restarting service..."
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          # Set executable permission
          chmod +x /home/administrator/TeamFees
          echo "‚úÖ Executable permission set"
          
          # Try to restart service with sudo (may require password)
          echo "üîÑ Attempting to restart service..."
          
          # Check if user has sudo without password
          if sudo -n true 2>/dev/null; then
            echo "‚úÖ Sudo access available"
            sudo systemctl stop teamfees 2>/dev/null || echo "‚ÑπÔ∏è Service not running or doesn't exist"
            sudo systemctl start teamfees 2>/dev/null || echo "‚ö†Ô∏è Could not start service via systemctl"
            sleep 3
            sudo systemctl status teamfees --no-pager 2>/dev/null || echo "‚ÑπÔ∏è Service status unavailable"
          else
            echo "‚ö†Ô∏è No sudo access - trying manual start"
            
            # Kill existing process if running
            pkill -f TeamFees 2>/dev/null || echo "‚ÑπÔ∏è No existing TeamFees process"
            
            # Start application manually in background
            cd /home/administrator
            export LD_LIBRARY_PATH=/home/administrator:$LD_LIBRARY_PATH
            nohup ./TeamFees > teamfees.log 2>&1 &
            
            sleep 3
            
            # Check if process is running
            if pgrep -f TeamFees > /dev/null; then
              echo "‚úÖ TeamFees started manually"
            else
              echo "‚ùå Failed to start TeamFees"
            fi
          fi
        EOF
        
    - name: Health check
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üè• Performing health check..."
        sleep 10
        
        # Try to connect to the API
        echo "Testing API endpoint..."
        if curl -f -m 30 http://$SERVER_HOST:9000/health 2>/dev/null; then
          echo "‚úÖ Health check passed - API is responding"
        elif curl -f -m 30 http://$SERVER_HOST:9000/ 2>/dev/null; then
          echo "‚úÖ API is responding (root endpoint)"
        else
          echo "‚ö†Ô∏è API not responding - checking process status"
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            echo "Checking TeamFees process:"
            if pgrep -f TeamFees > /dev/null; then
              echo "‚úÖ TeamFees process is running"
              echo "Process details:"
              ps aux | grep TeamFees | grep -v grep
            else
              echo "‚ùå TeamFees process not found"
            fi
            
            echo "\nChecking port 9000:"
            if netstat -tlnp 2>/dev/null | grep :9000; then
              echo "‚úÖ Port 9000 is in use"
            else
              echo "‚ùå Port 9000 not in use"
            fi
            
            echo "\nRecent logs (if available):"
            if [ -f /home/administrator/teamfees.log ]; then
              tail -10 /home/administrator/teamfees.log
            else
              echo "No log file found"
            fi
        EOF
        fi
        
    - name: Show recent logs
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "üìã Recent application logs:"
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "sudo journalctl -u teamfees -n 20 --no-pager"
        
    - name: Deploy summary
      if: always()
      run: |
        echo "üéâ Deploy Summary:"
        echo "=================="
        echo "üì¶ Binary: Uploaded"
        echo "üîß Permissions: Set"
        echo "üîÑ Service: Restarted"
        echo "üè• Health Check: ${{ job.status }}"
        echo "üåê API URL: http://${{ secrets.SERVER_HOST }}:9000"
        echo "üìä Logs: Available via journalctl"

  # Job 3: Notificar se bin√°rio n√£o existe
  notify-missing-binary:
    name: Notify Missing Binary
    runs-on: ubuntu-latest
    needs: check-binary
    if: needs.check-binary.outputs.binary-exists == 'false'
    
    steps:
    - name: Instructions for manual compilation
      run: |
        echo "‚ùå Deploy failed: Linux binary not found"
        echo ""
        echo "üìã To fix this:"
        echo "1. Open Delphi IDE"
        echo "2. Open TeamFees.dproj"
        echo "3. Select 'Linux64' platform"
        echo "4. Select 'Release' configuration"
        echo "5. Press Shift+F9 to build"
        echo "6. Commit and push the Linux64/Release/TeamFees file"
        echo ""
        echo "üí° Or run: msbuild TeamFees.dproj /p:Configuration=Release /p:Platform=Linux64"
        
        # Fail the job to make it clear
        exit 1